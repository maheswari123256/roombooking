<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Property</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      display: block;
      margin-bottom: 10px;
      padding: 8px;
      width: 300px;
    }
    .amenity-option {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .amenity-option img {
  width: 52px;      /* icon width */
  height: 52px;     /* icon height */
  margin-right: 8px;
  border-radius: 50%; /* circle shape */
  object-fit: cover;  /* maintain aspect ratio */
}

  </style>
</head>
<body>

<h1>Edit Property</h1>

<form id="editPropertyForm" enctype="multipart/form-data">
  <input type="text" name="title" id="title" placeholder="Title"><br>
  <input type="text" name="description" id="description" placeholder="Description"><br>
  <input type="text" name="location" id="location" placeholder="Location"><br>
  <input type="number" name="pricePerNight" id="pricePerNight" placeholder="Price (₹)"><br>

  <h3>Guest Capacity</h3>
  <input type="number" id="adults" name="guestCapacity[adults]" placeholder="Max Adults"><br>
  <input type="number" id="children" name="guestCapacity[children]" placeholder="Max Children"><br>
  <input type="number" id="infants" name="guestCapacity[infants]" placeholder="Max Infants"><br>
  <input type="number" id="pets" name="guestCapacity[pets]" placeholder="Max Pets"><br>
  <input type="number" id="maxGuests" name="guestCapacity[maxGuests]" placeholder="Total Max Guests"><br>

  <h3>Upload Interior Images</h3>
  <input type="file" name="interior" id="interior" multiple><br>

  <h3>Upload Exterior Images</h3>
  <input type="file" name="exterior" id="exterior" multiple><br>

  <h3>Select Amenities</h3>
  <div id="amenitiesContainer"></div>

  <br>
  <button type="submit">Update Property</button>
</form>

<script>
const token = localStorage.getItem("token");
const urlParams = new URLSearchParams(window.location.search);
const propertyId = urlParams.get("id");

async function loadPropertyAndAmenities() {
  try {
    // ✅ Load property details
    const propRes = await fetch(`/api/house/${propertyId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!propRes.ok) throw new Error("Property not found");
    const property = await propRes.json();

    // ✅ Load all amenities
    const amenRes = await fetch(`/api/amenities`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const allAmenities = await amenRes.json();

    // Fill form fields
    document.getElementById("title").value = property.title || "";
    document.getElementById("description").value = property.description || "";
    document.getElementById("location").value = property.location || "";
    document.getElementById("pricePerNight").value = property.pricePerNight || "";

    document.getElementById("adults").value = property.guestCapacity?.adults || 0;
    document.getElementById("children").value = property.guestCapacity?.children || 0;
    document.getElementById("infants").value = property.guestCapacity?.infants || 0;
    document.getElementById("pets").value = property.guestCapacity?.pets || 0;
    document.getElementById("maxGuests").value = property.guestCapacity?.maxGuests || 0;

    // ✅ Populate amenities checkboxes
    const amenitiesDiv = document.getElementById("amenitiesContainer");
    amenitiesDiv.innerHTML = "";
    allAmenities.forEach(amenity => {
      const isChecked = property.amenities?.some(a => a._id === amenity._id);
      const checkbox = `
  <label class="amenity-option">
    <input type="checkbox" name="amenities" value="${amenity._id}" ${isChecked ? "checked" : ""}>
    <img src="${amenity.iconUrl}" alt="${amenity.type}" />
    ${amenity.type}
  </label><br>
`;

      amenitiesDiv.insertAdjacentHTML("beforeend", checkbox);
    });

  } catch (err) {
    console.error("Error loading data:", err);
    alert("Failed to load property data.");
  }
}

document.getElementById("editPropertyForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  const formData = new FormData();

  formData.append("title", document.getElementById("title").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("location", document.getElementById("location").value);
  formData.append("price", document.getElementById("pricePerNight").value);

  formData.append("adults", document.getElementById("adults").value);
  formData.append("children", document.getElementById("children").value);
  formData.append("infants", document.getElementById("infants").value);
  formData.append("pets", document.getElementById("pets").value);
  formData.append("maxGuests", document.getElementById("maxGuests").value);

  // ✅ Files
  for (const file of document.getElementById("interior").files) {
    formData.append("interior", file);
  }
  for (const file of document.getElementById("exterior").files) {
    formData.append("exterior", file);
  }

  // ✅ Amenities
  document.querySelectorAll('input[name="amenities"]:checked').forEach(cb => {
    formData.append("amenities", cb.value);
  });

  try {
    const res = await fetch(`/api/house/update/${propertyId}`, {
      method: "PUT",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || "Update failed");
    alert("✅ Property updated successfully!");
    window.location.href = "/my-listing.html";

  } catch (err) {
    console.error("Update error:", err);
    alert("❌ Failed to update property: " + err.message);
  }
});

loadPropertyAndAmenities();
</script>

</body>
</html>
