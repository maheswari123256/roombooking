<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Bookings</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Segoe UI", sans-serif;
    }
    .sidebar {
      height: 100vh;
      background: #fff;
      border-right: 1px solid #ddd;
      padding-top: 20px;
      position: fixed;
      top: 0;
      left: 0;
    }
    .sidebar a {
      text-decoration: none;
      padding: 12px 20px;
      display: block;
      color: #333;
      font-weight: 500;
    }
    .sidebar a:hover {
      background-color: #f1f1f1;
      border-radius: 8px;
    }
    .sidebar .active {
      background-color: #0d6efd;
      color: white;
      border-radius: 8px;
    }
    .content {
      margin-left: 17%;
      padding: 20px;
    }
    .table thead {
      background-color: #0d6efd;
      color: white;
    }
    .btn-sm {
      padding: 4px 10px;
      font-size: 13px;
    }
    .date-inputs {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
    }
    .date-inputs input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <h4 class="text-center mb-4">Admin Panel</h4>
      <a href="dashboard.html"><i class="fa fa-home me-2"></i>Dashboard</a>
      <a href="users.html"><i class="fa fa-users me-2"></i>Users</a>
      <a href="manage-properties.html"><i class="fa fa-building me-2"></i>Properties</a>
      <a href="bookings.html" class="active"><i class="fa fa-calendar-check me-2"></i>Bookings</a>
      <a href="amenities.html"><i class="fa fa-couch me-2"></i>Amenities</a>
      <a href="reviews.html"><i class="fa fa-star me-2"></i>Reviews</a>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 content">
      <h3 class="mb-4">Bookings</h3>

      <!-- Date Filter -->
      

      <div class="card shadow-sm">
        <div class="card-body">
          <table class="table table-bordered table-hover" id="bookingTable">
            <thead>
              <tr>
                <th>User</th>
                <th>Property</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="bookingBody">
              <tr><td colspan="5" class="text-center text-muted">Loading bookings...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
  // Date Pickers
  let checkInPicker = flatpickr("#checkIn", {
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: function(selectedDates) {
      if (selectedDates.length > 0) {
        checkOutPicker.set("minDate", selectedDates[0]);
      }
    }
  });

  let checkOutPicker = flatpickr("#checkOut", {
    dateFormat: "Y-m-d",
    minDate: "today"
  });

  // Load Bookings
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    const bookingBody = document.getElementById("bookingBody");

    try {
      const res = await fetch("http://localhost:5000/api/booking/booking", {
        headers: { Authorization: `Bearer ${token}` },
      });

      const bookings = await res.json();
      bookingBody.innerHTML = "";

      if (!bookings.length) {
        bookingBody.innerHTML = `<tr><td colspan="5" class="text-center">No bookings found.</td></tr>`;
        return;
      }

      bookings.forEach((booking) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${booking.user?.email || "N/A"}</td>
          <td>${booking.property?.title || "N/A"}</td>
          <td>${new Date(booking.checkIn).toLocaleDateString()}</td>
          <td>${new Date(booking.checkOut).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="cancelBooking('${booking._id}')">
              <i class="fa fa-times"></i> Cancel
            </button>
          </td>
        `;

        bookingBody.appendChild(row);
      });
    } catch (error) {
      console.error("‚ùå Error loading bookings:", error);
      bookingBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading bookings.</td></tr>`;
    }
  });

  // Cancel Booking
  async function cancelBooking(id) {
    const token = localStorage.getItem("token");
    if (!confirm("Are you sure you want to cancel this booking?")) return;

    try {
      const res = await fetch(`http://localhost:5000/api/booking/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      if (res.ok) {
        alert("‚úÖ Booking cancelled");
        location.reload();
      } else {
        const err = await res.json();
        alert("‚ùå " + (err.message || "Failed to cancel booking"));
      }
    } catch (error) {
      console.error("‚ùå Cancel error:", error);
      alert("‚ùå Error while cancelling booking.");
    }
  }

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD8DOpnDhFMXXVOscjhLoW3If0ZhlKUBpo",
    authDomain: "staynotify-61da5.firebaseapp.com",
    projectId: "staynotify-61da5",
    storageBucket: "staynotify-61da5.firebasestorage.app",
    messagingSenderId: "580938949690",
    appId: "1:580938949690:web:2b6234577a9cbe7aad4103",
    measurementId: "G-RXTK4F53FS"
  };

  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // Notifications
  Notification.requestPermission().then((permission) => {
    if (permission === "granted") {
      messaging.getToken().then((token) => {
        console.log("FCM Token:", token);
        fetch("http://localhost:5000/api/user/save-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`
          },
          body: JSON.stringify({ token })
        });
      }).catch((err) => console.error("‚ùå Error getting FCM token:", err));
    } else {
      console.warn("üö´ Permission not granted for notifications");
    }
  });

  messaging.onMessage((payload) => {
    console.log("üì© Message received:", payload);
    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: "/images/key-cursor.png"
    });
  });

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("/firebase-messaging-sw.js")
      .then((registration) => console.log("Service Worker registered:", registration.scope))
      .catch((err) => console.error("‚ùå Service Worker registration failed:", err));
  }
</script>

</body>
</html>
